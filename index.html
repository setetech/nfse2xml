<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sete Tech | Gerador de XML a partir de PDF NFS-e</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <!-- Dependências para processamento de PDF e OCR -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .card-shadow {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.07), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .file-drop-zone {
            border: 2px dashed #cbd5e1;
            transition: background-color 0.2s ease-in-out, border-color 0.2s ease-in-out;
        }
        .file-drop-zone.dragover {
            background-color: #eef2ff;
            border-color: #4f46e5;
        }
        #progress-bar-inner {
            transition: width 0.3s ease-in-out;
        }
    </style>
</head>
<body class="bg-slate-100">

    <header class="bg-slate-800 text-white shadow-md">
        <div class="max-w-6xl mx-auto p-4 flex items-center gap-3">
            <svg class="w-8 h-8 text-indigo-400" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <path d="M12 2L2 7V17L12 22L22 17V7L12 2Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M2 7L12 12L22 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
                <path d="M12 22V12" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path>
            </svg>
            <h1 class="text-xl font-bold">Sete Tech</h1>
        </div>
    </header>

    <main class="p-4 md:p-8">
        <div class="w-full max-w-6xl mx-auto bg-white rounded-xl card-shadow overflow-hidden">
            <div class="p-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-2">Extrator de Dados e Gerador de XML NFS-e</h2>
                <p class="text-gray-600 mb-8">Carregue um arquivo PDF para extrair as informações e gerar o XML correspondente.</p>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                    <!-- Coluna de Entrada e Extração -->
                    <div class="space-y-6">
                        <!-- Área de Upload -->
                        <div>
                            <label for="pdf-input" class="block text-sm font-semibold text-gray-700 mb-2">1. Carregue o arquivo PDF:</label>
                            <label for="pdf-input" class="file-drop-zone w-full p-6 rounded-lg text-center cursor-pointer hover:bg-slate-50">
                                <div class="text-gray-500">
                                    <svg class="mx-auto h-12 w-12 text-slate-400" stroke="currentColor" fill="none" viewBox="0 0 48 48" aria-hidden="true"><path d="M28 8H12a4 4 0 00-4 4v20m32-12v8m0 0v8a4 4 0 01-4 4H12a4 4 0 01-4-4v-4m32-4l-3.172-3.172a4 4 0 00-5.656 0L28 28M8 32l9.172-9.172a4 4 0 015.656 0L28 28m0 0l4 4m4-24h8m-4-4v8" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"></path></svg>
                                    <p class="mt-2 text-sm"><span class="font-semibold text-indigo-600">Clique para carregar</span> ou arraste e solte</p>
                                    <p class="text-xs text-gray-500" id="file-name">Nenhum arquivo selecionado</p>
                                </div>
                                <input id="pdf-input" name="pdf-input" type="file" class="sr-only" accept="application/pdf">
                            </label>
                        </div>

                        <!-- Área de Progresso -->
                        <div id="progress-container" class="hidden">
                            <p id="progress-status" class="text-sm font-medium text-gray-700 mb-1">Processando...</p>
                            <div class="w-full bg-slate-200 rounded-full h-2.5">
                                <div id="progress-bar-inner" class="bg-indigo-600 h-2.5 rounded-full" style="width: 0%"></div>
                            </div>
                        </div>

                        <!-- Texto Extraído -->
                        <div>
                            <label for="text-output" class="block text-sm font-semibold text-gray-700 mb-2">2. Texto Extraído:</label>
                            <pre class="w-full h-80 bg-slate-50 text-slate-800 p-4 rounded-lg overflow-auto border border-slate-200"><code id="text-output">Aguardando arquivo PDF...</code></pre>
                        </div>
                    </div>

                    <!-- Coluna de Saída do XML -->
                    <div>
                        <div class="flex justify-between items-center mb-2">
                             <label for="xml-output" class="block text-sm font-semibold text-gray-700">3. XML Gerado:</label>
                             <button id="download-xml-btn" disabled class="px-4 py-2 text-sm font-medium text-white bg-indigo-600 rounded-md hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 disabled:bg-slate-400 disabled:cursor-not-allowed">
                                Baixar XML
                            </button>
                        </div>
                        <pre class="w-full h-full bg-slate-900 text-slate-200 p-4 rounded-lg overflow-auto border border-slate-700"><code id="xml-output">O resultado aparecerá aqui...</code></pre>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <footer class="text-center py-6 text-slate-500 text-sm">
        <p>&copy; <span id="footer-year"></span> Sete Tech. Todos os direitos reservados.</p>
    </footer>

    <script>
    window.addEventListener('load', () => {
        // --- Elementos da UI ---
        const pdfInput = document.getElementById('pdf-input');
        const fileNameEl = document.getElementById('file-name');
        const progressContainer = document.getElementById('progress-container');
        const progressStatusBar = document.getElementById('progress-status');
        const progressBarInner = document.getElementById('progress-bar-inner');
        const textOutput = document.getElementById('text-output');
        const xmlOutput = document.getElementById('xml-output');
        const dropZone = pdfInput.parentElement;
        const downloadBtn = document.getElementById('download-xml-btn');
        document.getElementById('footer-year').textContent = new Date().getFullYear();

        let rawXmlContent = '';
        let xmlFileName = 'documento.xml';

        // --- Verificação Crítica da Biblioteca PDF.js ---
        if (typeof pdfjsLib === 'undefined') {
            console.error('PDF.js library failed to load.');
            textOutput.textContent = 'Erro crítico: A biblioteca de PDF não pôde ser carregada. Verifique sua conexão com a internet e tente recarregar a página.';
            xmlOutput.textContent = 'Geração de XML desativada.';
            progressContainer.classList.remove('hidden');
            progressStatusBar.textContent = 'Falha ao carregar recursos.';
            pdfInput.disabled = true;
            dropZone.style.cursor = 'not-allowed';
            dropZone.title = 'Funcionalidade desativada';
            return; // Interrompe a execução do script
        }

        // Se a biblioteca carregou, configura o worker
        pdfjsLib.GlobalWorkerOptions.workerSrc = `https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js`;

        function extrairEntre(texto, delimitadorInicio, delimitadorFim) {
             const inicio = texto.indexOf(delimitadorInicio);
             const fim = texto.indexOf(delimitadorFim, inicio + delimitadorInicio.length);
             if (inicio === -1 || fim === -1) {
                  return ""; // Delimitadores não encontrados
             }
             return texto.substring(inicio + delimitadorInicio.length, fim);
        }
        

        // --- MÓDULO GERADOR DE XML ---
        class GeradorXml {
             parseValue(valor) {
                if (valor == null || valor === '') return 0;
                if (typeof valor === 'number' && isFinite(valor)) return valor;
                let str = String(valor).trim().replace(/R\$|\s/g, '').replace(/[^\d.,-]/g, '');
                const hasComma = str.indexOf(',') !== -1;
                const hasDot = str.indexOf('.') !== -1;
                if (hasComma && hasDot) { str = str.replace(/\./g, '').replace(',', '.'); }
                else if (hasComma && !hasDot) { str = str.replace(',', '.'); }
                const num = parseFloat(str);
                return isNaN(num) ? 0 : num;
            }

            extrairNumeroNota(texto) {
                const textoNormalizado = texto.replace(/\s+/g, ' ').trim();
                const tentativas = [
                    /NOTA\s+FISCAL\s+(?:DE\s+SERVIÇOS\s+ELETRÔNICA\s+)?N[º°]?\s*:?\s*(\d+)/i,
                    /N[UÚ]MERO\s+DA\s+NFS-E\s*(\d+)/i,
                    /N[UÚ]MERO\s+DA\s+NOTA\s*(\d+)/i,
                    /NFS-E\s*(\d+)/i,
                    /n[oº°](\d+)/i
                ];
                for (const regex of tentativas) {
                    const match = textoNormalizado.match(regex);
                    if (match && match[1]) {
                        return match[1].trim().replace(/^0+/, ''); // Remove leading zeros
                    }
                }

                let auxExtracao =  extrairEntre(texto,"PREFEITURA DO MUNICÍPIO DE SÃO PAULO |","EE:");
                auxExtracao = auxExtracao.replace(/\D/g, '')
                return auxExtracao;

            }
            extrairDataEmissao(texto) {
                const textoNormalizado = texto.replace(/\s+/g, ' ').trim();
                const tentativas = [
                    /DATA\s+(?:E\s+HORA\s+)?(?:DA|DE)\s+EMISS[ÃA]O\s*:?\s*(\d{2}\s*\/\s*\d{2}\s*\/\s*\d{4})/i,
                    /(\d{2}\s*\/\s*\d{2}\s*\/\s*\d{4})/
                ];
                 for (const regex of tentativas) {
                    const match = textoNormalizado.match(regex);
                    if (match && match[1]) {
                        return match[1].trim();
                    }
                }
                return null;
            }
            extrairVlServico(texto) {
                const textoNormalizado = texto.replace(/\s+/g, ' ').trim();
                
                const tentativas = [
                    /VALOR\s+TOTAL\s+DO(?:S)?\s+SERVI[ÇC]O(?:S)?\s*=?\s*R?\$?\s*([\d.,]+)/i,
                    /V[IL]\.?\s*L[IÍ]QUIDO\s+DA\s+NOTA\s+FISCAL\s+R?\$?\s*([\d.,]+)/i,
                    /V[IL]\.?\s*TOTAL\s+DOS\s+SERVI[ÇC]OS[^R]*R?\$?\s*([\d.,]+)/i,
                    /BASE\s+DE\s+C[AÁ]LCULO\s+TOTAL[^R]*R?\$?\s*([\d.,]+)/i,
                    /VALOR\s+DO\s+SERVI[CÇ]O[^R]*R?\$?\s*([\d.,]+)/i,
                    /BASE\s+DE\s+C[AÁ]LCULO\s*\(R\$\)\s*[:=]?\s*([\d.,]+)/i,
                    /Vs+\A+s*\L+s*\O+s*\R+s*\L+s*\I[Í]+s*Q+s*\U+s*\I+s*\D+s*\O+s*\=+s*(\d+)/i,
                    /([\d]{1,3}(?:\.\d{3})*,\d{2})\s+DOCUMENTO\s+EMITIDO\s+POR\s+ME\s+OU\s+EPP/i
                ];
                for (const regex of tentativas) {
                    const match = textoNormalizado.match(regex);
                    if (match && match[1]) {
                        const valor = this.parseValue(match[1]);
                        if (valor > 0) return valor;
                    }
                }
                return null;
            }
            gerarXmlDeTexto(textoPdf) {
                const numeroNota = this.extrairNumeroNota(textoPdf);
                const dataEmissao = this.extrairDataEmissao(textoPdf);
                const vlServico = this.extrairVlServico(textoPdf);
                
                // Encode the full text to Base64
                const textoBase64 = btoa(unescape(encodeURIComponent(textoPdf)));

                let dataFormatada;
                if (dataEmissao) {
                    dataFormatada = dataEmissao.split('/').reverse().join('-');
                } else {
                    const today = new Date();
                    const year = today.getFullYear();
                    const month = String(today.getMonth() + 1).padStart(2, '0');
                    const day = String(today.getDate()).padStart(2, '0');
                    dataFormatada = `${year}-${month}-${day}`;
                }

                const valorFormatado = vlServico ? vlServico.toFixed(2) : '0.00';
                
                const rawXml = `<?xml version="1.0" encoding="UTF-8"?>
<dyscamp>
    <NumeroNota>${numeroNota || 'NAO_ENCONTRADO'}</NumeroNota>
    <VlServico>${valorFormatado}</VlServico>
    <DataEmissao>${dataFormatada}</DataEmissao>
    <TextoBase64>${textoBase64}</TextoBase64>
</dyscamp>`;

                const displayXml = `&lt;?xml version="1.0" encoding="UTF-8"?&gt;
&lt;dyscamp&gt;
    &lt;NumeroNota&gt;${numeroNota || 'NAO_ENCONTRADO'}&lt;/NumeroNota&gt;
    &lt;VlServico&gt;${valorFormatado}&lt;/VlServico&gt;
    &lt;DataEmissao&gt;${dataFormatada}&lt;/DataEmissao&gt;
    &lt;TextoBase64&gt;${textoBase64}&lt;/TextoBase64&gt;
&lt;/dyscamp&gt;`;
                
                return {
                    display: displayXml,
                    raw: rawXml,
                    numeroNota: numeroNota
                };
            }
        }

        // --- LÓGICA DA PÁGINA E PROCESSAMENTO DE PDF ---
        const updateProgress = (status, percentage) => {
            progressContainer.classList.remove('hidden');
            progressStatusBar.textContent = status;
            progressBarInner.style.width = `${percentage}%`;
        };

        const handleFile = async (file) => {
            if (!file || file.type !== 'application/pdf') {
                console.warn('Por favor, selecione um arquivo PDF válido.');
                return;
            }

            fileNameEl.textContent = file.name;
            textOutput.textContent = 'Processando o arquivo...';
            xmlOutput.textContent = 'Aguardando extração...';
            downloadBtn.disabled = true;
            progressBarInner.classList.remove('bg-red-600');
            progressBarInner.classList.add('bg-indigo-600');

            try {
                updateProgress('Carregando arquivo...', 5);
                const arrayBuffer = await file.arrayBuffer();
                const typedarray = new Uint8Array(arrayBuffer);
                const pdfDoc = await pdfjsLib.getDocument({ data: typedarray }).promise;
                const totalPages = pdfDoc.numPages;

                let allText = "";

                // 1. Extração de texto nativo
                updateProgress(`Extraindo texto nativo (Página 1 de ${totalPages})`, 15);
                for (let i = 1; i <= totalPages; i++) {
                    const page = await pdfDoc.getPage(i);
                    const textContent = await page.getTextContent();
                    const strings = textContent.items.map(item => item.str).join(" ");
                    allText += "\n" + strings;
                    updateProgress(`Extraindo texto nativo (Página ${i} de ${totalPages})`, 15 + (i/totalPages * 20));
                }

                // 2. Decide se precisa de OCR
                const temValores = /R\$\s*[\d.,]+/i.test(allText);
                const textoCompleto = allText.length > 300;

                if (!temValores || !textoCompleto) {
                     updateProgress('Texto nativo insuficiente, iniciando OCR...', 35);
                     const worker = await Tesseract.createWorker('por');
                     let ocrText = "";

                     for (let i = 1; i <= totalPages; i++) {
                        const page = await pdfDoc.getPage(i);
                        const viewport = page.getViewport({ scale: 2.0 });
                        const canvas = document.createElement('canvas');
                        const context = canvas.getContext('2d');
                        canvas.height = viewport.height;
                        canvas.width = viewport.width;
                        
                        await page.render({ canvasContext: context, viewport: viewport }).promise;
                        
                        const ocrProgress = 35 + (i / totalPages) * 60; // OCR de 35% a 95%
                        updateProgress(`Processando OCR - Página ${i}/${totalPages}`, ocrProgress);
                        
                        const { data: { text } } = await worker.recognize(canvas);
                        ocrText += text + "\n";
                     }

                     allText = ocrText;
                     await worker.terminate();
                }

                updateProgress('Processamento concluído!', 100);

                // 3. Exibir texto e gerar XML
                textOutput.textContent = allText;
                const gerador = new GeradorXml();
                const xmlData = gerador.gerarXmlDeTexto(allText);
                
                rawXmlContent = xmlData.raw;
                xmlFileName = `nota_${xmlData.numeroNota || 'desconhecido'}.xml`;

                xmlOutput.innerHTML = xmlData.display;
                downloadBtn.disabled = false; // Habilita o botão

            } catch (error) {
                console.error('Erro no processamento do PDF:', error);
                textOutput.textContent = `Erro ao processar o PDF: ${error.message}`;
                xmlOutput.textContent = 'Falha na geração.';
                updateProgress('Erro!', 100);
                progressBarInner.classList.remove('bg-indigo-600');
                progressBarInner.classList.add('bg-red-600');
            }
        };

        // --- Event Listeners ---
        pdfInput.addEventListener('change', (e) => handleFile(e.target.files[0]));

        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.classList.add('dragover');
        });
        dropZone.addEventListener('dragleave', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
        });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.classList.remove('dragover');
            if (e.dataTransfer.files.length) {
                pdfInput.files = e.dataTransfer.files;
                handleFile(e.dataTransfer.files[0]);
            }
        });
        downloadBtn.addEventListener('click', () => {
            if (!rawXmlContent) return;
            const blob = new Blob([rawXmlContent], { type: 'application/xml;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = xmlFileName;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });
    });
    </script>
</body>
</html>


















